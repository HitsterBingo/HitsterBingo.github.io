<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hitster Game</title>
  <style>
    body {
      margin: 0;
      background-color: #121212;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #qr-reader {
      width: 300px;
    }
  </style>
</head>
<body>
  <h1>Scan een Spotify QR-code ðŸŽ¶</h1>
  <div id="qr-reader"></div>

  <!-- Load HTML5 QR Code lib -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8"></script>

  <!-- Start QR code scanner -->
  <script>
    window.onload = function () {
      const token = localStorage.getItem("spotify_access_token");
      if (!token) return (window.location.href = "/");

      const html5QrCode = new Html5Qrcode("qr-reader");

      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          const obsCam = cameras.find(cam => cam.label.toLowerCase().includes('obs')) || cameras[0];
          html5QrCode.start(
            { deviceId: { exact: obsCam.id } },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
              console.log("QR scan:", decodedText);
              if (decodedText.includes("spotify.com/track/")) {
                const trackId = decodedText.split("/track/")[1].split("?")[0];
                playTrack(trackId);
                html5QrCode.stop();
              }
            },
            (err) => {
              console.warn("QR scan error", err);
            }
          );
        } else {
          alert("Geen camera gevonden!");
        }
      }).catch(err => {
        console.error("Camera error", err);
        alert("Kon geen camera vinden.");
      });
    };

    function playTrack(trackId) {
      if (!window.spotifyDeviceId) {
        return console.error("Spotify device niet klaar");
      }

      fetch(`https://api.spotify.com/v1/me/player/play?device_id=${window.spotifyDeviceId}`, {
        method: 'PUT',
        body: JSON.stringify({ uris: [`spotify:track:${trackId}`] }),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem("spotify_access_token")}`
        },
      }).then(res => {
        if (!res.ok) {
          console.error("Speel track fout:", res);
        } else {
          console.log("Track speelt af ðŸŽµ");
        }
      });
    }
  </script>

  <!-- Spotify SDK + init -->
  <script>
    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = localStorage.getItem("spotify_access_token");
      if (!token) return (window.location.href = "/");

      const player = new Spotify.Player({
        name: "Hitster Game Player",
        getOAuthToken: cb => cb(token),
        volume: 0.8,
      });

      player.addListener("ready", ({ device_id }) => {
        console.log("Spotify player ready with ID", device_id);
        window.spotifyDeviceId = device_id;
      });

      player.addListener("initialization_error", ({ message }) =>
        console.error("Init error", message)
      );
      player.addListener("authentication_error", ({ message }) => {
        console.error("Auth error", message);
        localStorage.removeItem("spotify_access_token");
        alert("Je Spotify-token is verlopen, log opnieuw in.");
        window.location.href = "/";
      });

      player.connect();
    };
    <script src="index.js" defer></script>
  </script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
</body>
</html>
